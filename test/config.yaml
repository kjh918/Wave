SETTING:
  User: jhkim
  Node: all.q@ngsnode1

  workflow_name: cbNIPT_QC_Pipeline
  version: v0.0.1
  description: ''

WORK_PARAMETERS:
  input_path: /storage/home/jhkim/Projects/cbNIPT/GCX-cbNIPT_QC_Setup-2025-10-23/Resources/Rawdata/WGS/{sample_id}_R{read}.fastq.gz
  work_dir_path: /storage/home/jhkim/Projects/cbNIPT/GCX-cbNIPT_QC_Setup-2025-10-23/Results/Test
  
TASK_LIST:
  - Rawdata_FastQC:
      TOOL: fastqc
      WORK_DIR: "{work_dir_path}/{sample_id}/00_Rawdata_FastQC"
      THREADS: 2
      INPUT:
        read1: "/storage/home/jhkim/Projects/cbNIPT/GCX-cbNIPT_QC_Setup-2025-10-23/Resources/Rawdata/WGS/{sample_id}_R1.fastq.gz"
        read2: "/storage/home/jhkim/Projects/cbNIPT/GCX-cbNIPT_QC_Setup-2025-10-23/Resources/Rawdata/WGS/{sample_id}_R2.fastq.gz"
      OUTPUT:
        read1: "{WORK_DIR}/{sample_id}_R1_fastqc/fastqc_data.txt"
        read2: "{WORK_DIR}/{sample_id}_R2_fastqc/fastqc_data.txt"
      PARAMS:
        extract: true
  
  - Trimdata_FastP: 
      TOOL: fastp
      WORK_DIR: "{work_dir_path}/{sample_id}/01_Trimdata_FastP"
      THREADS: 2
      INPUT:
        read1: "/storage/home/jhkim/Projects/cbNIPT/GCX-cbNIPT_QC_Setup-2025-10-23/Resources/Rawdata/WGS/{sample_id}_R1.fastq.gz"
        read2: "/storage/home/jhkim/Projects/cbNIPT/GCX-cbNIPT_QC_Setup-2025-10-23/Resources/Rawdata/WGS/{sample_id}_R2.fastq.gz"
      OUTPUT:
        read1: "{WORK_DIR}/{sample_id}_R1.trimed.fastq.gz"
        read2: "{WORK_DIR}/{sample_id}_R2.trimed.fastq.gz"
        json: "{WORK_DIR}/{sample_id}.fastp.json"
        html: "{WORK_DIR}/{sample_id}.fastp.html"
      PARAMS: 
        image: /storage/images/fastp-0.23.4.sif
        binds: ["/storage","/data"]
        THREADS: 2
        PicoplexGold: True
        trim_front1: 0
        trim_front2: 0
        length_required: 100
        average_qual: 10
        qualified_quality_phred: 15
      
  - Trimdata_FastQC:
      TOOL: fastqc
      WORK_DIR: "{work_dir_path}/{sample_id}/02_Trimdata_FastQC"
      THREADS: 2
      INPUT:
        read1: "{work_dir_path}/{sample_id}/01_Trimdata_FastP/{sample_id}_R1.trimed.fastq.gz"
        reqd2: "{work_dir_path}/{sample_id}/01_Trimdata_FastP/{sample_id}_R2.trimed.fastq.gz"
      OUTPUT:
        read1: "{WORK_DIR}/{sample_id}_R1.trimed_fastqc/fastqc_data.txt"
        reqd2: "{WORK_DIR}/{sample_id}_R2.trimed_fastqc/fastqc_data.txt"
      PARAMS:
        THREADS: 4
        extract: true

  - Picard_FastqToSam:
      TOOL: picard
      FUNC: fastqtosam
      WORK_DIR: "{work_dir_path}/{sample_id}/02_FastqToSam"
      THREADS: 14                  # (옵션) 인터페이스 상 존재, 실제 picard 호출엔 java 옵션으로 반영
      INPUT:
        read1: "{TrimFastqDir}/{sample_id}.trimmed_R1.fastq.gz"
        read2: "{TrimFastqDir}/{sample_id}.trimmed_R2.fastq.gz"
      OUTPUT:
        bam: "{WORK_DIR}/{sample_id}.fastqtosam.bam"
      PARAMS:
        sample_name: "{sample_id}"
        read_group_id: "{ReadGroupID}"
        platform: "{ReadGroupPlatform}"
        library_name: "{ReadGroupLibrary}"
        sequencing_center: "{ReadGroupCenter}"
        tmp_dir: "{TmpDir}"
        java_bin: "java"
        jar: "/storage/apps/bin/picard.jar"
        xmx_gb: 16
        parallel_gc_THREADS: 14

  - Picard_MergeBamAlignment:
      TOOL: picard
      FUNC: mergebamalignment
      WORK_DIR: "{work_dir_path}/{sample_id}/03_Merge"
      INPUT:
        unmapped_bam: "{work_dir_path}/{sample_id}/02_FastqToSam/{sample_id}.fastqtosam.bam"
        aligned_bam:  "{work_dir_path}/{sample_id}/02_Bwa/{sample_id}.bwa.mem.sam"
        reference:    "/ref/hg38.fa"
      OUTPUT:
        bam: "{WORK_DIR}/{sample_id}.primary.bam"

  - Samtools_Sort:
      TOOL: samtools
      FUNC: sort
      THREADS: 4
      WORK_DIR: "{work_dir_path}/{sample_id}/04_Sort"
      INPUT:
        bam_in: "{work_dir_path}/{sample_id}/03_Merge/{sample_id}.primary.bam"
      OUTPUT:
        bam: "{WORK_DIR}/{sample_id}.sorted.bam"
      PARAMS:
        mem_per_thread: "1G"

  - Samtools_Index:
      TOOL: samtools
      FUNC: index
      THREADS: 4
      WORK_DIR: "{work_dir_path}/{sample_id}/05_Index"
      INPUT:
        bam: "{work_dir_path}/{sample_id}/04_Sort/{sample_id}.sorted.bam"
      OUTPUT:
        index: "{WORK_DIR}/{sample_id}.sorted.bam.bai"
      PARAMS:
        index_type: bai

  - MarkDuplicates:
      TOOL: gatk
      FUNC: markduplicates
      WORK_DIR: "{work_dir_path}/{sample_id}/04_MarkDuplicates"
      THREADS: 14
      INPUT:
        bam: "{work_dir_path}/{sample_id}/04_Sort/{sample_id}.sorted.bam"
      OUTPUT:
        dir: "{WORK_DIR}"
        bam: "{WORK_DIR}/{sample_id}.sorted.dedup.bam"
        metrics: "{WORK_DIR}/{sample_id}.mark.duplicates.metrics.txt"
      PARAMS:
        create_index: true
        remove_sequencing_duplicates: true
        xmx_gb: 16
        parallel_gc_THREADS: 14
        image: "/storage/images/gatk-4.4.0.0.sif"
        binds: ["/storage", "/data"]

  # 2) RealignerTargetCreator (GATK3)
  - RealignerTargetCreator:
      TOOL: gatk3
      FUNC: realignertargetcreator
      WORK_DIR: "{work_dir_path}/{sample_id}/05_Realign"
      THREADS: 8
      INPUT:
        bam: "{work_dir_path}/{sample_id}/04_MarkDuplicates/{sample_id}.sorted.dedup.bam"
        reference: "/storage/ref/hg38.fa"
        known_indel1: "/storage/ref/known_indels1.vcf.gz"
        known_indel2: "/storage/ref/known_indels2.vcf.gz"
      OUTPUT:
        dir: "{WORK_DIR}"
        intervals: "{WORK_DIR}/{sample_id}.realign.target.intervals"
      PARAMS:
        xmx_gb: 16
        nt: 8
        image: "/storage/images/gatk-3.8-1.sif"
        binds: ["/storage", "/data"]

  # 3) IndelRealigner (GATK3)
  - IndelRealigner:
      TOOL: gatk3
      FUNC: indelrealigner
      WORK_DIR: "{work_dir_path}/{sample_id}/05_Realign"
      THREADS: 1
      INPUT:
        bam: "{work_dir_path}/{sample_id}/04_MarkDuplicates/{sample_id}.sorted.dedup.bam"
        reference: "/storage/ref/hg38.fa"
        intervals: "{work_dir_path}/{sample_id}/05_Realign/{sample_id}.realign.target.intervals"
        known_indel1: "/storage/ref/known_indels1.vcf.gz"
        known_indel2: "/storage/ref/known_indels2.vcf.gz"
      OUTPUT:
        dir: "{WORK_DIR}"
        bam: "{WORK_DIR}/{sample_id}.sorted.dedup.realign.bam"
      PARAMS:
        xmx_gb: 16
        image: "/storage/images/gatk-3.8-1.sif"
        binds: ["/storage", "/data"]

  # 4) BaseRecalibrator (GATK4)
  - BaseRecalibrator:
      TOOL: gatk
      FUNC: baserecalibrator
      WORK_DIR: "{work_dir_path}/{sample_id}/06_BQSR"
      THREADS: 14
      INPUT:
        bam: "{work_dir_path}/{sample_id}/05_Realign/{sample_id}.sorted.dedup.realign.bam"
        reference: "/storage/ref/hg38.fa"
        known_sites:
          - "/storage/ref/known_snps.vcf.gz"
          - "/storage/ref/known_indels1.vcf.gz"
          - "/storage/ref/known_indels2.vcf.gz"
      OUTPUT:
        dir: "{WORK_DIR}"
        table: "{WORK_DIR}/{sample_id}.recal.table.txt"
      PARAMS:
        xmx_gb: 16
        parallel_gc_THREADS: 14
        image: "/storage/images/gatk-4.4.0.0.sif"
        binds: ["/storage", "/data"]

  # 5) ApplyBQSR (GATK4)
  - ApplyBQSR:
      TOOL: gatk
      FUNC: applybqsr
      WORK_DIR: "{work_dir_path}/{sample_id}/06_BQSR"
      THREADS: 14
      INPUT:
        bam: "{work_dir_path}/{sample_id}/05_Realign/{sample_id}.sorted.dedup.realign.bam"
        bqsr_table: "{work_dir_path}/{sample_id}/06_BQSR/{sample_id}.recal.table.txt"
      OUTPUT:
        dir: "{WORK_DIR}"
        bam: "{WORK_DIR}/{sample_id}.recal.bam"
      PARAMS:
        xmx_gb: 16
        parallel_gc_THREADS: 14
        image: "/storage/images/gatk-4.4.0.0.sif"
        binds: ["/storage", "/data"]