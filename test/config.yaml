SETTING:
  User: jhkim
  Node: all.q@ngsnode1

  workflow_name: cbNIPT_QC_Pipeline
  version: v0.0.1
  description: ''

WORK_PARAMETERS:
  input_path: /storage/home/jhkim/Projects/cbNIPT/GCX-cbNIPT_QC_Setup-2025-10-23/Resources/Rawdata/WGS/{sample_id}_R{read}.fastq.gz
  work_dir_path: /storage/home/jhkim/Projects/cbNIPT/GCX-cbNIPT_QC_Setup-2025-10-23/Results/Test

  reference_genome: /storage/references_and_index/hg38/fasta/cbNIPT/hg38.fa
  known_snp: /storage/references_and_index/hg38/vcf/Homo_sapiens_assembly38.dbsnp138.vcf.gz
  known_indel1: /storage/references_and_index/hg38/vcf/Homo_sapiens_assembly38.known_indels.vcf.gz
  known_indel2: /storage/references_and_index/hg38/vcf/Mills_and_1000G_gold_standard.indels.hg38.vcf.gz


TASK_LIST:
  - Rawdata_FastQC:
      TOOL: fastqc
      WORK_DIR: "{work_dir_path}/{sample_id}/00_Rawdata_FastQC"
      THREADS: 2
      INPUT:
        read1: "/storage/home/jhkim/Projects/cbNIPT/GCX-cbNIPT_QC_Setup-2025-10-23/Resources/Rawdata/WGS/{sample_id}_R1.fastq.gz"
        read2: "/storage/home/jhkim/Projects/cbNIPT/GCX-cbNIPT_QC_Setup-2025-10-23/Resources/Rawdata/WGS/{sample_id}_R2.fastq.gz"
      OUTPUT:
        read1: "{WORK_DIR}/{sample_id}_R1_fastqc/fastqc_data.txt"
        read2: "{WORK_DIR}/{sample_id}_R2_fastqc/fastqc_data.txt"
      PARAMS:
        extract: true
  
  - Trimdata_FastP: 
      TOOL: fastp
      WORK_DIR: "{work_dir_path}/{sample_id}/01_Trimdata_FastP"
      THREADS: 2
      INPUT:
        read1: "/storage/home/jhkim/Projects/cbNIPT/GCX-cbNIPT_QC_Setup-2025-10-23/Resources/Rawdata/WGS/{sample_id}_R1.fastq.gz"
        read2: "/storage/home/jhkim/Projects/cbNIPT/GCX-cbNIPT_QC_Setup-2025-10-23/Resources/Rawdata/WGS/{sample_id}_R2.fastq.gz"
      OUTPUT:
        read1: "{WORK_DIR}/{sample_id}_R1.trimed.fastq.gz"
        read2: "{WORK_DIR}/{sample_id}_R2.trimed.fastq.gz"
        json: "{WORK_DIR}/{sample_id}.fastp.json"
        html: "{WORK_DIR}/{sample_id}.fastp.html"
      PARAMS: 
        image: /storage/images/fastp-0.23.4.sif
        binds: "/storage,/data"
        THREADS: 2
        PicoplexGold: True
        trim_front1: 0
        trim_front2: 0
        length_required: 100
        average_qual: 10
        qualified_quality_phred: 15
      
  - Trimdata_FastQC:
      TOOL: fastqc
      WORK_DIR: "{work_dir_path}/{sample_id}/02_Trimdata_FastQC"
      THREADS: 2
      INPUT:
        read1: "{work_dir_path}/{sample_id}/01_Trimdata_FastP/{sample_id}_R1.trimed.fastq.gz"
        read2: "{work_dir_path}/{sample_id}/01_Trimdata_FastP/{sample_id}_R2.trimed.fastq.gz"
      OUTPUT:
        read1: "{WORK_DIR}/{sample_id}_R1.trimed_fastqc/fastqc_data.txt"
        read2: "{WORK_DIR}/{sample_id}_R2.trimed_fastqc/fastqc_data.txt"
      PARAMS:
        THREADS: 4
        extract: true

  - Unalign_FastqToSam_Picard:
      TOOL: picard
      FUNC: fastqtosam
      WORK_DIR: "{work_dir_path}/{sample_id}/03_Unalign_FastqToSam_Picard"
      THREADS: 14                  # (옵션) 인터페이스 상 존재, 실제 picard 호출엔 java 옵션으로 반영
      INPUT:
        read1: "{work_dir_path}/{sample_id}/01_Trimdata_FastP/{sample_id}_R1.trimed.fastq.gz"
        read2: "{work_dir_path}/{sample_id}/01_Trimdata_FastP/{sample_id}_R2.trimed.fastq.gz"
      OUTPUT:
        bam: "{WORK_DIR}/{sample_id}.fastqtosam.bam"
      PARAMS:
        read_group_id: "GENCURIX"
        platform: "ILLUMINA"
        library_name: "WGS"
        sequencing_center: "GENCURIX"
        tmp_dir: "{WORK_DIR}"
        java_bin: "java"
        jar: "/storage/apps/bin/picard.jar"
        xmx_gb: 16
        parallel_gc_THREADS: 14
        
  - Align_SAM_Bwa:
      TOOL: picard
      FUNC: fastqtosam
      WORK_DIR: "{work_dir_path}/{sample_id}/04_Align_SAM_Bwa"
      THREADS: 14                  # (옵션) 인터페이스 상 존재, 실제 picard 호출엔 java 옵션으로 반영
      INPUT:
        read1: "{work_dir_path}/{sample_id}/01_Trimdata_FastP/{sample_id}_R1.trimed.fastq.gz"
        read2: "{work_dir_path}/{sample_id}/01_Trimdata_FastP/{sample_id}_R2.trimed.fastq.gz"
      OUTPUT:
        bam: "{WORK_DIR}/{sample_id}.bwa.mem.sam"
      PARAMS:
        reference_genome: "{reference_genome}"
        read_length: 50
        read_group_id: "GENCURIX"
        center: "GENCURIX"
        platform: "ILLUMINA"
        library_name: "WGS"
        sample_id: '{sample_id}'
        images: "/storage/images/bwa-0.7.17.sif"
        binds: "/storage,/data"

  - Picard_MergeBamAlignment:
      TOOL: picard
      FUNC: mergebamalignment
      THREADS: 14
      WORK_DIR: "{work_dir_path}/{sample_id}/05_MergeBam_Picard"
      INPUT:
        unmapped_bam: "{work_dir_path}/{sample_id}/03_Unalign_FastqToSam_Picard/{sample_id}.fastqtosam.bam"
        aligned_bam:  "{work_dir_path}/{sample_id}/04_Align_SAM_Bwa/{sample_id}.bwa.mem.sam"
        reference:    "{reference_genome}"
      OUTPUT:
        bam: "{WORK_DIR}/{sample_id}.primary.bam"
      PARAMS:
        xmx_gb: 16
        parallel_gc_threads: 14
        primary_strategy: MostDistant
        create_index: True


  - Samtools_Sort:
      TOOL: samtools
      FUNC: sort
      THREADS: 4
      WORK_DIR: "{work_dir_path}/{sample_id}/05_MergeBam_Picard"
      INPUT:
        bam_in: "{work_dir_path}/{sample_id}/05_MergeBam_Picard/{sample_id}.primary.bam"
      OUTPUT:
        bam: "{WORK_DIR}/{sample_id}.sorted.bam"
      PARAMS:
        mem_per_thread: "1G"

  - Samtools_Index:
      TOOL: samtools
      FUNC: index
      THREADS: 4
      WORK_DIR: "{work_dir_path}/{sample_id}/05_MergeBam_Picard"
      INPUT:
        bam: "{work_dir_path}/{sample_id}/05_MergeBam_Picard/{sample_id}.sorted.bam"
      OUTPUT:
        index: "{WORK_DIR}/{sample_id}.sorted.bam.bai"
      PARAMS:
        index_type: bai

  - MarkDuplicates:
      TOOL: gatk4
      FUNC: markduplicates
      WORK_DIR: "{work_dir_path}/{sample_id}/06_MarkDuplicates_GATK"
      THREADS: 14
      INPUT:
        bam: "{work_dir_path}/{sample_id}/05_MergeBam_Picard/{sample_id}.sorted.bam"
      OUTPUT:
        dir: "{WORK_DIR}"
        bam: "{WORK_DIR}/{sample_id}.sorted.dedup.bam"
        metrics: "{WORK_DIR}/{sample_id}.mark.duplicates.metrics.txt"
      PARAMS:
        create_index: true
        remove_sequencing_duplicates: true
        xmx_gb: 16
        parallel_gc_THREADS: 14
        image: "/storage/images/gatk-4.4.0.0.sif"
        binds: "/storage,/data"

  - RealignerTargetCreator:
      TOOL: gatk3
      FUNC: realignertargetcreator
      WORK_DIR: "{work_dir_path}/{sample_id}/07_Realign_GATK"
      THREADS: 8
      INPUT:
        bam: "{work_dir_path}/{sample_id}/06_MarkDuplicates_GATK/{sample_id}.sorted.dedup.bam"
      OUTPUT:
        dir: "{WORK_DIR}"
        intervals: "{WORK_DIR}/{sample_id}.realign.target.intervals"
      PARAMS:
        reference: "{reference_genome}"
        known_indel1: "{known_indel1}"
        known_indel2: "{known_indel2}"
        image: "/storage/images/gatk-3.8-1.sif"
        binds: "/storage,/data"
        xmx_gb: 16
        nt: 8

  - IndelRealigner:
      TOOL: gatk3
      FUNC: indelrealigner
      WORK_DIR: "{work_dir_path}/{sample_id}/07_Realign_GATK"
      THREADS: 1
      INPUT:
        bam: "{work_dir_path}/{sample_id}/06_MarkDuplicates_GATK/{sample_id}.sorted.dedup.bam"
        intervals: "{work_dir_path}/{sample_id}/07_Realign_GATK/{sample_id}.realign.target.intervals"
      OUTPUT:
        dir: "{WORK_DIR}"
        bam: "{WORK_DIR}/{sample_id}.sorted.dedup.realign.bam"
      PARAMS:
        known_indel1: "{known_indel1}"
        known_indel2: "{known_indel2}"
        reference: "{reference_genome}"
        image: "/storage/images/gatk-3.8-1.sif"
        binds: "/storage,/data"
        xmx_gb: 16

  - BaseRecalibrator:
      TOOL: gatk4
      FUNC: baserecalibrator
      WORK_DIR: "{work_dir_path}/{sample_id}/08_BQSR_GATK"
      THREADS: 14
      INPUT:
        bam: "{work_dir_path}/{sample_id}/07_Realign_GATK/{sample_id}.sorted.dedup.realign.bam"
      OUTPUT:
        table: "{WORK_DIR}/{sample_id}.recal.table.txt"
      PARAMS:
        reference: "{reference_genome}"
        known_snp: "{known_snp}"
        known_indel1: "{known_indel1}"
        known_indel2: "{known_indel2}"
        xmx_gb: 16
        parallel_gc_THREADS: 14
        image: "/storage/images/gatk-4.4.0.0.sif"
        binds: "/storage,/data"

  # # 5) ApplyBQSR (GATK4)
  - ApplyBQSR:
      TOOL: gatk4
      FUNC: applybqsr
      WORK_DIR: "{work_dir_path}/{sample_id}/08_BQSR_GATK"
      THREADS: 14
      INPUT:
        bam: "{work_dir_path}/{sample_id}/07_Realign_GATK/{sample_id}.sorted.dedup.realign.bam"
        bqsr_table: "{work_dir_path}/{sample_id}/08_BQSR_GATK/{sample_id}.recal.table.txt"
      OUTPUT:
        bam: "{WORK_DIR}/{sample_id}.recal.bam"
      PARAMS:
        xmx_gb: 16
        parallel_gc_THREADS: 14
        image: "/storage/images/gatk-4.4.0.0.sif"
        binds: "/storage,/data"
